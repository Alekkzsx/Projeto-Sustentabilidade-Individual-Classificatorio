import json
import os
from datetime import datetime

# ConfiguraÃ§Ã£o do arquivo JSON
ARQUIVO_GASTOS = 'gastos_usuarios.json'

def carregar_historico():
    """Carrega os dados do arquivo JSON"""
    if not os.path.exists(ARQUIVO_GASTOS):
        return {"usuarios": {}}
    
    with open(ARQUIVO_GASTOS, 'r') as f:
        return json.load(f)

def exibir_historico_categoria(usuario, tipo):
    """Exibe o histÃ³rico de uma categoria especÃ­fica"""
    dados = carregar_historico()
    usuario = usuario.lower()
    
    print("\n" + "â•" * 40)
    print(f" HISTÃ“RICO DE {tipo.upper()} ".center(40, 'â”€'))
    print("â•" * 40)
    
    if usuario not in dados['usuarios']:
        print("\nğŸ” UsuÃ¡rio nÃ£o encontrado")
        print("â•" * 40)
        return
    
    registros = dados['usuarios'][usuario]
    
    if not registros:
        print("\nğŸ“­ Nenhum registro encontrado para este usuÃ¡rio")
        print("â•" * 40)
        return
    
    print(f"\nUsuÃ¡rio: {usuario.capitalize()}")
    print(f"Total de registros: {len(registros)}")
    print("â•" * 40)

    # Exibindo os registros conforme o tipo solicitado
    for idx, registro in enumerate(registros, 1):
        print(f"\nğŸ“… Registro #{idx} - {registro.get('data_hora', 'Sem data')}")
        
        if tipo == 'agua':
            print(f"ğŸ’§ Ãgua: {registro['agua']['valor']} litros")
            print(f"ClassificaÃ§Ã£o: {registro['agua']['classificacao']}")
        elif tipo == 'energia':
            print(f"âš¡ Energia: {registro['energia']['valor']} kWh")
            print(f"ClassificaÃ§Ã£o: {registro['energia']['classificacao']}")
        elif tipo == 'residuos':
            print(f"â™»ï¸ ResÃ­duos: {registro['residuos']['valor']}%")
            print(f"ClassificaÃ§Ã£o: {registro['residuos']['classificacao']}")
        elif tipo == 'transporte':
            print(f"ğŸšŒ Transportes:")
            for transporte in registro['transportes']:
                print(f"  Meio: {transporte['meio']} | Viagens: {transporte['viagens']} | ClassificaÃ§Ã£o: {transporte['classificacao']}")
        
    print("â•" * 40)

def exibir_todas_categorias():
    """Exibe a visÃ£o combinada de todas as categorias"""
    print("\n" + "â•" * 40)
    print(" VISUALIZAÃ‡ÃƒO INTEGRADA ".center(40, 'â”€'))
    print("â•" * 40)
    
    dados = carregar_historico()
    print("\nCarregando dados combinados...")
    
    for usuario, registros in dados['usuarios'].items():
        print(f"\nUsuÃ¡rio: {usuario.capitalize()}")
        print("Total de registros: ", len(registros))
        print("â•" * 40)

        for idx, registro in enumerate(registros, 1):
            print(f"\nğŸ“… Registro #{idx} - {registro.get('data_hora', 'Sem data')}")
            print(f"ğŸ’§ Ãgua: {registro['agua']['valor']} litros - {registro['agua']['classificacao']}")
            print(f"âš¡ Energia: {registro['energia']['valor']} kWh - {registro['energia']['classificacao']}")
            print(f"â™»ï¸ ResÃ­duos: {registro['residuos']['valor']}% - {registro['residuos']['classificacao']}")
            print(f"ğŸšŒ Transportes:")
            for transporte in registro['transportes']:
                print(f"  Meio: {transporte['meio']} | Viagens: {transporte['viagens']} | ClassificaÃ§Ã£o: {transporte['classificacao']}")
            print("â•" * 40)
    
    print("â•" * 40)

def mostrar_menu():
    """Exibe o menu principal para escolha de histÃ³ricos"""
    print("\n" + "â•" * 40)
    print(f"{' MENU DE HISTÃ“RICOS ':=^40}")
    print("â•" * 40)
    print(f"{'1. HistÃ³rico de Ãgua':<38} ")
    print(f"{'2. HistÃ³rico de Energia':<38} ")
    print(f"{'3. HistÃ³rico de Transporte':<38} ")
    print(f"{'4. HistÃ³rico de ResÃ­duos':<38} ") 
    print(f"{'5. Todas as Categorias':<38} ")  # Nova opÃ§Ã£o
    print(f"{'6. Sair do Sistema':<38} ")      # OpÃ§Ã£o de saÃ­da ajustada
    print("â•" * 40)

def main():
    """FunÃ§Ã£o principal com nova opÃ§Ã£o integrada"""
    usuario = input("Digite o nome do usuÃ¡rio para acessar o histÃ³rico: ").strip()

    while True:
        mostrar_menu()
        opcao = input("\nEscolha o histÃ³rico desejado (1-6): ").strip()  # Ajustado para 6 opÃ§Ãµes
        
        if opcao == "1":
            exibir_historico_categoria(usuario, 'agua')
        elif opcao == "2":
            exibir_historico_categoria(usuario, 'energia')
        elif opcao == "3":
            exibir_historico_categoria(usuario, 'transporte')
        elif opcao == "4":
            exibir_historico_categoria(usuario, 'residuos')
        elif opcao == "5":  # Nova opÃ§Ã£o
            exibir_todas_categorias()
        elif opcao == "6":
            print("\n" + "â•" * 40)
            print(f"{' OBRIGADO POR USAR O SISTEMA! ':=^40}")
            print("â•" * 40 + "\n")
            break
        else:
            print("\nâš  OpÃ§Ã£o invÃ¡lida! Use valores de 1 a 6.") 
            input("Pressione Enter para tentar novamente...")

if __name__ == "__main__":
    main()
